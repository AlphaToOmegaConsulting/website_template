---
interface Props {
  id: string;
  title: string;
  description?: string;
  triggerLabel: string;
  triggerVariant?: 'primary' | 'secondary' | 'ghost';
  triggerSize?: 'sm' | 'md' | 'lg';
}

const {
  id,
  title,
  description,
  triggerLabel,
  triggerVariant = 'primary',
  triggerSize = 'md',
} = Astro.props;

const dialogId = `dialog-${id}`;
const titleId = `${dialogId}-title`;
const descriptionId = description ? `${dialogId}-description` : undefined;
---

<div>
  <button
    type="button"
    data-dialog-trigger={dialogId}
    class="inline-flex items-center justify-center font-medium rounded-md transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-accent focus-visible:ring-offset-2"
    class:list={[
      triggerVariant === 'primary' && 'bg-brand-accent text-white hover:bg-brand-primary',
      triggerVariant === 'secondary' && 'bg-gray-600 text-white hover:bg-gray-700',
      triggerVariant === 'ghost' && 'bg-transparent text-brand-primary hover:bg-gray-50',
      triggerSize === 'sm' && 'px-3 py-1.5 text-sm',
      triggerSize === 'md' && 'px-4 py-2 text-base',
      triggerSize === 'lg' && 'px-6 py-3 text-lg',
    ]}
  >
    {triggerLabel}
  </button>

  <dialog
    id={dialogId}
    aria-labelledby={titleId}
    aria-describedby={descriptionId}
    class="backdrop:bg-black backdrop:opacity-50 p-0 rounded-lg shadow-xl max-w-md w-full"
  >
    <div class="bg-white rounded-lg p-6">
      <div class="flex items-start justify-between mb-4">
        <h2
          id={titleId}
          class="text-xl font-semibold text-gray-900"
        >
          {title}
        </h2>
        <button
          type="button"
          data-dialog-close={dialogId}
          class="text-gray-400 hover:text-gray-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-accent rounded"
          aria-label="Close dialog"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>

      {description && (
        <p
          id={descriptionId}
          class="text-gray-600 mb-4"
        >
          {description}
        </p>
      )}

      <div class="dialog-content">
        <slot />
      </div>
    </div>
  </dialog>
</div>

<script>
  // Dialog functionality with focus trap and ESC handling
  document.addEventListener('DOMContentLoaded', () => {
    const triggers = document.querySelectorAll('[data-dialog-trigger]');
    const closeButtons = document.querySelectorAll('[data-dialog-close]');

    triggers.forEach((trigger) => {
      trigger.addEventListener('click', () => {
        const dialogId = trigger.getAttribute('data-dialog-trigger');
        const dialog = document.getElementById(dialogId) as HTMLDialogElement;
        if (dialog) {
          dialog.showModal();
          trapFocus(dialog);
        }
      });
    });

    closeButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const dialogId = button.getAttribute('data-dialog-close');
        const dialog = document.getElementById(dialogId) as HTMLDialogElement;
        if (dialog) {
          dialog.close();
        }
      });
    });

    // Close on backdrop click
    document.querySelectorAll('dialog').forEach((dialog) => {
      dialog.addEventListener('click', (e) => {
        const rect = dialog.getBoundingClientRect();
        const isInDialog =
          rect.top <= e.clientY &&
          e.clientY <= rect.top + rect.height &&
          rect.left <= e.clientX &&
          e.clientX <= rect.left + rect.width;

        if (!isInDialog) {
          dialog.close();
        }
      });

      // ESC key handling (native dialog behavior)
      dialog.addEventListener('cancel', (e) => {
        // Allow default ESC behavior to close dialog
      });
    });

    function trapFocus(dialog: HTMLDialogElement) {
      const focusableElements = dialog.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      const firstElement = focusableElements[0] as HTMLElement;
      const lastElement = focusableElements[focusableElements.length - 1] as HTMLElement;

      dialog.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
          if (e.shiftKey) {
            if (document.activeElement === firstElement) {
              e.preventDefault();
              lastElement.focus();
            }
          } else {
            if (document.activeElement === lastElement) {
              e.preventDefault();
              firstElement.focus();
            }
          }
        }
      });

      // Focus first element when dialog opens
      firstElement?.focus();
    }
  });
</script>
